Trino and Hive on Kubernetes
============================

Kustomize and supporting scripts for running Trinodb (prestosql) and 
a Hive 3 Metastore in Kubernetes using S3 object storage and MySQL. 


Author:  Timothy C. Arland  
Email:   <tcarland@gmail.com>, <tarland@trace3.com>  <br> 
Version: v21.07

<br>

## Prerequisites:
- Kustomize >= v3.2.0
- Bash >= v4.x
- Docker 20.10
- Kubernetes >= 1.18

<br>

## Configuring the Environment

The project depends on a number of environment variables for deploying the 
necessary configuration via a setup script. S3 Credentials are the primary 
varables that are required, with others having default values if not provided.  
The following table defines the list of variables used by the `./bin/setup.sh` 
script.

| Environment Variable |    Description   |  Default Setting |
| -------------------- | -------------------------------| ---------------|
| S3_ENDPOINT          |  The S3 endpoint url |       |
| S3_ACCESS_KEY        |  The S3 access key  |     |
| S3_SECRET_KEY        |  The S3 secret key |       |
|  ----------------    |  ------------------------  |  -------------------  |
| TRINO_NAMESPACE      |  Namespace for deploying the components | `trino`  |
| MYSQLD_USER          |  Name of the hive mysql db user  | `root` |
| MYSQLD_ROOT_PASSWORD |  Password for the mysql root user |  *randomized-password* |

<br>

## Building the Metastore image

The metastore image is based off of Hive version 3.1.2 and can be  
built using the provided *hive3/Dockerfile*. 
```
$ make docker 
#  or run the script 
$ cd hive3 && ../bin/docker_build.sh myrepo/hive:3.1.2
```

To use a private registry, set the var DOCKER_REPOSITORY first.
```sh
export DOCKER_REPOSITORY="gcr.io/myproject"
../bin/docker_build.sh myrepo/hive:3.1.2
docker push ${DOCKER_REGISTRY}/myrepo/hive:3.1.2
```

## Configure the Environment

Ensure all variables above are defined and *exported* to the environment.
Run the setup script to configure the various config templates.
```
./bin/setup.sh
```
Copy the env or inherit all vars to the current environment 
via `eval $(./bin/setup.sh)`

<br>

## Deploy the MySQL Server

Deploy the MySQL Server via Kustomize.
```
kustomize build mysql-server/ | kubectl apply -f -
```

The same Mysql image can be used as a client.
```
docker run -it --rm mysql mysql -hsome.mysql.host -usome-mysql-user -p
```

<br>

## Deploy the Hive 3 Metastore
We deploy the metastore using Kustomize.
```
kustomize build hive-metastore/ kubectl apply -f -
```

Note this includes the init job *hive-init-schema.yaml* that was 
generated by the setup script.  This job will run the Hive *schematool* 
for provisioning the database. 

<br>

## Trino (trino-355)

Verify the parameter substitution is correct in *trino/base/configmap.yaml* 
as generated by the *setup.sh* script.

Load the Trino manifests.
```
kustomize build trino/ | kubectl apply -f -
```

Enable external access to the coordinator via *LoadBalancer*. This 
requires MetalLB or other ELB support in K8s.
```sh
kubectl patch service trino-coordinator-service -n trino -p '{"spec": {"type": "LoadBalancer"}}'
```

## Trino CLI

Trino CLI can be acquired (here)[https://repo1.maven.org/maven2/io/trino/trino-cli/358/trino-cli-358-executable.jar]
```
trino --server 172.19.0.203:8080 --catalog hive --schema default
```

<br>

---

<br>

### Creating ConfigMaps or Secrets example
```sh
( cat conf/metastore-site.xml.template | envsubst > metastore-site.xml )
( cat conf/core-site.xml.template | envsubst > core-site.xml )

( kubectl create configmap hive-metastore-cm \
  --dry-run \
  --namespace $TRINO_NAMESPACE \
  --from-file=metastore-site.xml \
  --from-file=core-site.xml -o yaml > hive-metastore-cm.yaml )

( rm -f metastore-site.xml core-site.xml )

( kubectl create secret generic hive-secrets \
  --from-literal=access-key="$S3_ACCESS_KEY" \
  --from-literal=secret-key="$S3_SECRET_KEY" \
  -n $TRINO_NAMESPACE )
```

testing:
```sh
kubectl run --namespace $TRINO_NAMESPACE curl --image=radial/busyboxplus:curl -i --tty 
```

